name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]
    paths:
      # Include code files
      - "**.dart"
      - "**.ts"
      - "**.tsx"
      - "**.js"
      - "**.jsx"
      - "**.go"
      - "**.py"
      - "**.java"
      - "**.kt"
      - "**.swift"
      - "**.rs"
      - "**.c"
      - "**.cpp"
      - "**.h"
      - "pubspec.yaml"
      - "package.json"
      - "go.mod"
      - "Cargo.toml"
      - "requirements.txt"
      # Exclude documentation and config (unless critical)
      - "!**.md"
      - "!docs/**"
      - "!.github/**"
      - "!*.yml"
      - "!*.yaml"
      - "!LICENSE"
      - "!.gitignore"

# Prevent multiple reviews from running simultaneously on the same PR
concurrency:
  group: code-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  MAX_RUNTIME_MINUTES: 20

jobs:
  determine-review-model:
    runs-on: ubuntu-latest
    outputs:
      model: ${{ steps.complexity.outputs.model }}
      should_review: ${{ steps.complexity.outputs.should_review }}
      review_depth: ${{ steps.complexity.outputs.review_depth }}
    steps:
      - name: Analyze PR complexity
        id: complexity
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          SHOULD_REVIEW="true"
          MODEL="claude-sonnet-4-5"
          REVIEW_DEPTH="standard"

          # Skip draft PRs
          if [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            SHOULD_REVIEW="false"
          fi

          # Get PR metadata
          PR_NUM="${{ github.event.pull_request.number }}"
          CHANGES=$(gh pr view $PR_NUM --json additions,deletions --jq '.additions + .deletions')
          FILES_CHANGED=$(gh pr view $PR_NUM --json files --jq '.files | length')

          echo "üìä PR Stats: $CHANGES lines changed, $FILES_CHANGED files"

          # Skip very large PRs
          if [ "$CHANGES" -gt 1000 ]; then
            SHOULD_REVIEW="false"
            echo "‚ö†Ô∏è PR too large for automated review"
          fi

          # Check labels for review hints
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'

          if echo "$LABELS" | grep -qE "skip-review|no-review"; then
            SHOULD_REVIEW="false"
            echo "‚è≠Ô∏è Review skipped by label"
          fi

          # Determine model based on complexity
          if [ "$SHOULD_REVIEW" == "true" ]; then
            # Use Opus for complex PRs
            if echo "$LABELS" | grep -qE "security|critical|architecture|refactor"; then
              MODEL="claude-opus-4-6"
              REVIEW_DEPTH="thorough"
              echo "üîç Using Opus for thorough security/architecture review"
            elif [ "$CHANGES" -gt 500 ] || [ "$FILES_CHANGED" -gt 20 ]; then
              MODEL="claude-opus-4-6"
              REVIEW_DEPTH="thorough"
              echo "üîç Using Opus for large/complex PR"
            elif echo "$LABELS" | grep -qE "hotfix|bug|simple"; then
              MODEL="claude-sonnet-4-5"
              REVIEW_DEPTH="focused"
              echo "‚ö° Using Sonnet for focused review"
            else
              MODEL="claude-sonnet-4-5"
              REVIEW_DEPTH="standard"
              echo "‚úì Using Sonnet for standard review"
            fi
          fi

          echo "model=$MODEL" >> $GITHUB_OUTPUT
          echo "should_review=$SHOULD_REVIEW" >> $GITHUB_OUTPUT
          echo "review_depth=$REVIEW_DEPTH" >> $GITHUB_OUTPUT

  claude-review:
    needs: determine-review-model
    if: needs.determine-review-model.outputs.should_review == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write  # Upgraded to write for posting review comments
      issues: read
      id-token: write
      actions: read  # Enable reading CI results for context

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Get full history for better context

      - name: Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}

          # Enable CI integration
          additional_permissions: |
            actions: read

          plugin_marketplaces: 'https://github.com/anthropics/claude-code.git'
          plugins: 'code-review@claude-code-plugins'

          prompt: |
            Review this pull request with ${{ needs.determine-review-model.outputs.review_depth }} depth.

            ${{ needs.determine-review-model.outputs.review_depth == 'thorough' && '## THOROUGH REVIEW MODE
            - Deep analysis of architecture and design decisions
            - Security audit with threat modeling
            - Performance profiling and optimization opportunities
            - Comprehensive edge case analysis
            - Cross-cutting concerns (logging, monitoring, error handling)' || '' }}

            ${{ needs.determine-review-model.outputs.review_depth == 'focused' && '## FOCUSED REVIEW MODE
            - Quick security scan
            - Critical bug detection
            - Obvious logic errors
            - Basic best practices check' || '' }}

            ## Priority Areas
            1. **Security vulnerabilities** (XSS, SQL injection, auth issues, secret exposure)
            2. **Critical bugs** (null pointer, race conditions, logic errors)
            3. **Performance issues** (N+1 queries, memory leaks, inefficient algorithms)
            4. **Data integrity** (validation, consistency, error handling)

            ## Secondary Review
            5. Code quality and maintainability
            6. Best practices and patterns
            7. Test coverage gaps
            8. Documentation needs

            ## Review Guidelines
            - Only report high-confidence issues
            - Provide specific fix suggestions with code examples
            - Consider the broader context and existing patterns
            - Be constructive and educational
            - For ${{ needs.determine-review-model.outputs.model }} reviews, be ${{ needs.determine-review-model.outputs.model == 'claude-opus-4-6' && 'especially thorough and detail-oriented' || 'efficient and focused on critical issues' }}

            ## PR Context
            - Repository: ${{ github.repository }}
            - PR: #${{ github.event.pull_request.number }}
            - Author: @${{ github.event.pull_request.user.login }}
            - Author Association: ${{ github.event.pull_request.author_association }}
            - Review Model: ${{ needs.determine-review-model.outputs.model }}
            - Review Depth: ${{ needs.determine-review-model.outputs.review_depth }}

            /code-review:code-review ${{ github.repository }}/pull/${{ github.event.pull_request.number }}

          # Use dynamically selected model
          claude_args: |
            --model "${{ needs.determine-review-model.outputs.model }}"
            --max-turns ${{ needs.determine-review-model.outputs.model == 'claude-opus-4-6' && '75' || '50' }}
            --timeout ${{ needs.determine-review-model.outputs.model == 'claude-opus-4-6' && '1200000' || '900000' }}

      - name: Report status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Code review completed successfully"
          else
            echo "‚ö†Ô∏è Code review completed with status: ${{ job.status }}"
          fi

